name: WyneOS Core CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  core_validation:
    name: WyneOS Core Integrity & Build Checks
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          check-latest: true

      - name: Install Dependencies
        run: |
          cd WyneOS
          npm install

      - name: TypeScript Compile Check
        run: |
          cd WyneOS
          npx tsc --noEmit

      - name: Validate JSON Manifests
        shell: pwsh
        run: |
          Write-Host "Checking JSON validity..."
          $jsonFiles = Get-ChildItem -Path "WyneOS" -Filter *.json -Recurse
          foreach ($file in $jsonFiles) {
            try {
              Get-Content $file.FullName | ConvertFrom-Json | Out-Null
              Write-Host "VALID: $($file.FullName)"
            } catch {
              Write-Error "INVALID JSON: $($file.FullName)"
              exit 1
            }
          }

      - name: Basic Security Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

      - name: Upload CI Logs
        uses: actions/upload-artifact@v4
        with:
          name: wyneos-ci-logs
          path: |
            WyneOS/Core/**/*.ts
            WyneOS/**/*.json
            WyneOS/tsconfig.json
